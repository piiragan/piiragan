<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏á‡∏≠‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .status-present { background-color: #dcfce7; border-color: #16a34a; }
        .status-absent { background-color: #fef2f2; border-color: #dc2626; }
        .status-leave { background-color: #fefce8; border-color: #ca8a04; }
        .status-late { background-color: #fff7ed; border-color: #ea580c; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { 
            background-color: white; 
            margin: 2% auto; 
            padding: 15px; 
            border-radius: 10px; 
            width: 95%; 
            max-width: 600px; 
            max-height: 95vh; 
            overflow-y: auto; 
        }
        @media (min-width: 768px) {
            .modal-content {
                margin: 5% auto;
                padding: 20px;
                width: 90%;
            }
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button.active { background-color: #022c8b; color: white; }
        .primary-blue { background-color: #022c8b; }
        .primary-blue-light { background-color: #1e40af; }
        .primary-blue-hover:hover { background-color: #1e3a8a; }
        .banner-upload { 
            position: relative; 
            min-height: 150px; 
            background-size: cover; 
            background-position: center; 
        }
        @media (min-width: 768px) {
            .banner-upload {
                min-height: 200px;
            }
        }
        
        /* Responsive table styles */
        .responsive-table {
            display: block;
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .responsive-table table {
            width: 100%;
            min-width: 600px;
        }
        
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-text-sm {
                font-size: 0.875rem !important;
            }
            
            .mobile-p-2 {
                padding: 0.5rem !important;
            }
            
            .mobile-hidden {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Academic Year Selection Page -->
    <div id="yearSelectionPage" class="min-h-screen flex items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 lg:p-8 max-w-4xl w-full">
            <div class="text-center mb-6 sm:mb-8">
                <div class="banner-upload mb-4 sm:mb-6 rounded-lg" id="yearBanner" style="background-image: linear-gradient(135deg, #022c8b, #1e40af);">
                    <div class="flex items-center justify-center h-full p-4 sm:p-6 lg:p-8">
                        <div class="text-center text-white">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                                <span class="text-2xl sm:text-3xl">üè´</span>
                            </div>
                            <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold mb-1 sm:mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
                            <h2 class="text-base sm:text-lg lg:text-xl mb-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏á‡∏≠‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</h2>
                            <p class="text-xs sm:text-sm opacity-90">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£: <span id="directorNameDisplay">‡∏ô‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏î‡∏ä ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡πá‡∏á</span></p>
                            <p class="text-xs sm:text-sm opacity-90">‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                        </div>
                    </div>
                </div>
                <h3 class="text-lg sm:text-xl lg:text-2xl font-semibold text-gray-800 mb-3 sm:mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
                <p class="text-gray-600 text-sm sm:text-base">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4" id="yearOptions">
                <!-- Years will be populated here -->
            </div>
        </div>
    </div>

    <!-- Main System -->
    <div id="mainSystem" style="display: none;">
        <!-- Header -->
        <header class="primary-blue shadow-lg">
            <div class="banner-upload" id="mainBanner" style="background-image: linear-gradient(135deg, #022c8b, #1e40af);">
                <div class="container mx-auto px-2 sm:px-4 py-4 sm:py-6">
                    <div class="flex justify-between items-start">
                        <div class="text-center flex-1">
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 mb-2">
                                <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white rounded-full flex items-center justify-center">
                                    <span class="text-xl sm:text-2xl" id="schoolLogo">üè´</span>
                                </div>
                                <div class="text-white text-center sm:text-left">
                                    <h1 class="text-lg sm:text-2xl lg:text-3xl font-bold mb-1">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
                                    <h2 class="text-base sm:text-lg lg:text-xl mb-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏á‡∏≠‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</h2>
                                    <p class="text-xs sm:text-sm opacity-90">‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£: <span id="directorNameMain">‡∏ô‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏î‡∏ä ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡πá‡∏á</span></p>
                                    <p class="text-xs sm:text-sm opacity-90">‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                                </div>
                            </div>
                            <div class="text-white text-xs sm:text-sm">
                                <div class="flex flex-col sm:flex-row items-center justify-center gap-2">
                                    <span>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: <span id="currentAcademicYear" class="font-semibold">2568</span></span>
                                    <button onclick="showYearSelection()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 sm:px-3 py-1 rounded text-xs sm:text-sm transition-colors">
                                        üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button onclick="showBannerSettings()" class="text-white hover:bg-white hover:bg-opacity-20 p-1 sm:p-2 rounded transition-colors text-sm sm:text-base">
                            ‚öôÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="container mx-auto px-2 sm:px-4 py-2 sm:py-4">
            <div class="bg-white rounded-lg shadow-md p-2 sm:p-4 mb-4 sm:mb-6">
                <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-1 sm:gap-2 justify-center">
                    <button onclick="showTab('homepage')" class="tab-button active px-2 sm:px-4 py-2 rounded-lg font-medium transition-colors text-xs sm:text-sm">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
                    <button onclick="showTab('attendance')" class="tab-button px-2 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-xs sm:text-sm">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                    <button onclick="showTab('summary')" class="tab-button px-2 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-xs sm:text-sm">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    <button onclick="showTab('behavior')" class="tab-button px-2 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-gray-200 text-xs sm:text-sm">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</button>
                    <button onclick="showSupportSystem()" class="px-2 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-orange-200 hover:bg-orange-300 text-xs sm:text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
                    <button onclick="showClassroomManagement()" class="px-2 sm:px-4 py-2 rounded-lg font-medium transition-colors bg-green-200 hover:bg-green-300 text-xs sm:text-sm">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </div>
            </div>

        <!-- Homepage Tab -->
        <div id="homepage" class="tab-content active">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-6">
                <h3 class="text-lg sm:text-xl lg:text-2xl font-semibold mb-4 sm:mb-6 text-center">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                    <!-- Pie Chart -->
                    <div class="bg-gray-50 rounded-lg p-3 sm:p-6">
                        <h4 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-center">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
                        <div class="flex justify-center">
                            <canvas id="attendanceChart" width="250" height="250" class="sm:w-[300px] sm:h-[300px]"></canvas>
                        </div>
                        <div id="chartLegend" class="mt-3 sm:mt-4 grid grid-cols-1 sm:grid-cols-2 gap-1 sm:gap-2 text-xs sm:text-sm"></div>
                    </div>
                    
                    <!-- Statistics -->
                    <div class="space-y-3 sm:space-y-4">
                        <div class="bg-green-50 rounded-lg p-3 sm:p-4 border-l-4 border-green-500">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-green-800 text-sm sm:text-base">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                <span id="totalStudents" class="text-xl sm:text-2xl font-bold text-green-600">0</span>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-3 sm:p-4 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-blue-800 text-sm sm:text-base">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                                <div class="text-right">
                                    <span id="presentCount" class="text-xl sm:text-2xl font-bold text-blue-600">0</span>
                                    <div id="presentPercent" class="text-xs sm:text-sm text-blue-600">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-red-50 rounded-lg p-3 sm:p-4 border-l-4 border-red-500">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-red-800 text-sm sm:text-base">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                                <div class="text-right">
                                    <span id="absentCount" class="text-xl sm:text-2xl font-bold text-red-600">0</span>
                                    <div id="absentPercent" class="text-xs sm:text-sm text-red-600">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-orange-50 rounded-lg p-3 sm:p-4 border-l-4 border-orange-500">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-orange-800 text-sm sm:text-base">‡∏™‡∏≤‡∏¢</span>
                                <div class="text-right">
                                    <span id="lateCount" class="text-xl sm:text-2xl font-bold text-orange-600">0</span>
                                    <div id="latePercent" class="text-xs sm:text-sm text-orange-600">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 rounded-lg p-3 sm:p-4 border-l-4 border-yellow-500">
                            <div class="flex justify-between items-center">
                                <span class="font-medium text-yellow-800 text-sm sm:text-base">‡∏•‡∏≤</span>
                                <div class="text-right">
                                    <span id="leaveCount" class="text-xl sm:text-2xl font-bold text-yellow-600">0</span>
                                    <div id="leavePercent" class="text-xs sm:text-sm text-yellow-600">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 sm:mt-8 text-center">
                    <p class="text-gray-600 text-sm sm:text-base">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span id="lastUpdateDate" class="font-semibold"></span></p>
                </div>
            </div>
        </div>

        <!-- Classroom Selection -->
        <div class="bg-white rounded-lg shadow-md p-3 sm:p-6 mb-4 sm:mb-6" id="classroomSelectionDiv" style="display: none;">
            <div class="flex flex-col sm:flex-row sm:flex-wrap items-start sm:items-center gap-3 sm:gap-4">
                <label class="font-medium text-gray-700 text-sm sm:text-base">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                <select id="classroomSelect" onchange="loadClassroom()" class="w-full sm:w-auto px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                </select>
                <input type="date" id="attendanceDate" class="w-full sm:w-auto px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm sm:text-base">
                <span id="currentTime" class="text-xs sm:text-sm text-gray-600 font-medium"></span>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-6">
                <div id="classroomInfo" class="mb-4 sm:mb-6 p-3 sm:p-4 bg-blue-50 rounded-lg" style="display: none;">
                    <h3 class="text-base sm:text-lg font-semibold text-blue-800 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 sm:gap-4 text-sm sm:text-base">
                        <p><span class="font-medium">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</span> <span id="classLevel"></span></p>
                        <p><span class="font-medium">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:</span> <span id="teacherName"></span></p>
                    </div>
                </div>

                <!-- Status Legend -->
                <div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-medium mb-3 text-sm sm:text-base">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-3">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-green-500 rounded"></div>
                            <span class="text-xs sm:text-sm">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-red-500 rounded"></div>
                            <span class="text-xs sm:text-sm">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-yellow-500 rounded"></div>
                            <span class="text-xs sm:text-sm">‡∏•‡∏≤</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-orange-500 rounded"></div>
                            <span class="text-xs sm:text-sm">‡∏™‡∏≤‡∏¢</span>
                        </div>
                    </div>
                </div>

                <!-- Student List -->
                <div id="studentList" class="space-y-3">
                    <p class="text-gray-500 text-center py-8 text-sm sm:text-base">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p>
                </div>

                <!-- Notes Section -->
                <div class="mt-4 sm:mt-6">
                    <label class="block font-medium text-gray-700 mb-2 text-sm sm:text-base">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</label>
                    <textarea id="behaviorNotes" rows="3" class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm sm:text-base" placeholder="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ..."></textarea>
                </div>

                <!-- Save Button -->
                <div class="mt-4 sm:mt-6 text-center">
                    <button onclick="saveAttendance()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 sm:px-8 py-2 sm:py-3 rounded-lg font-medium transition-colors text-sm sm:text-base">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-6">
                <h3 class="text-lg sm:text-xl font-semibold mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <div id="summaryContent">
                    <p class="text-gray-500 text-center py-8 text-sm sm:text-base">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                </div>
            </div>
        </div>

        <!-- Behavior Tab -->
        <div id="behavior" class="tab-content">
            <div class="bg-white rounded-lg shadow-md p-3 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                    <h3 class="text-lg sm:text-xl font-semibold">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button onclick="showBehaviorManagement()" class="w-full sm:w-auto bg-orange-600 hover:bg-orange-700 text-white px-3 sm:px-4 py-2 rounded-lg font-medium text-sm sm:text-base">
                        ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                    </button>
                </div>
                <div id="behaviorContent">
                    <p class="text-gray-500 text-center py-8 text-sm sm:text-base">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</p>
                </div>
            </div>
        </div>

            <!-- Support System Tab -->
            <div id="support" class="tab-content">
                <div class="bg-white rounded-lg shadow-md p-3 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-semibold mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                    <div id="supportContent">
                        <p class="text-gray-500 text-center py-8 text-sm sm:text-base">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>

            <!-- Classroom Management Tab -->
            <div id="classroomManage" class="tab-content">
                <div class="bg-white rounded-lg shadow-md p-3 sm:p-6">
                    <h3 class="text-lg sm:text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div id="classroomManageContent">
                        <p class="text-gray-500 text-center py-8 text-sm sm:text-base">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <div class="text-6xl text-green-500 mb-4">‚úì</div>
                <h3 class="text-xl font-semibold text-green-800 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</h3>
                <div id="successSummary" class="bg-green-50 p-4 rounded-lg mb-4"></div>
                <button onclick="closeModal('successModal')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                    ‡∏ï‡∏Å‡∏•‡∏á
                </button>
            </div>
        </div>
    </div>

    <!-- Add Classroom Modal -->
    <div id="addClassroomModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</label>
                    <input type="text" id="newClassLevel" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.1/1">
                </div>
                <div>
                    <label class="block font-medium mb-2">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:</label>
                    <input type="text" id="newTeacherName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤">
                </div>
                <div>
                    <label class="block font-medium mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà):</label>
                    <textarea id="newStudentList" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà,‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•&#10;‡πÄ‡∏ä‡πà‡∏ô: 1,12345,‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ&#10;2,12346,‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"></textarea>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="addNewClassroom()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex-1">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                </button>
                <button onclick="closeModal('addClassroomModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
            <input type="password" id="passwordInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <div class="flex gap-4">
                <button onclick="checkPassword()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏ï‡∏Å‡∏•‡∏á
                </button>
                <button onclick="closeModal('passwordModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Behavior Management Modal -->
    <div id="behaviorModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h3>
            <div id="behaviorModalContent"></div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
            <div id="editStudentContent"></div>
        </div>
    </div>

    <!-- Banner Settings Modal -->
    <div id="bannerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</h3>
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">‡∏£‡∏π‡∏õ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á:</label>
                    <input type="file" id="bannerImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block font-medium mb-2">‡∏ï‡∏£‡∏≤‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                    <div class="space-y-2">
                        <input type="file" id="schoolLogoFile" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <input type="text" id="schoolLogoText" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="üè´ (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥)">
                        <div class="text-sm text-gray-600">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥</div>
                    </div>
                </div>
                <div>
                    <label class="block font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£:</label>
                    <input type="text" id="directorName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="‡∏ô‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏î‡∏ä ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡πá‡∏á">
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="saveBannerSettings()" class="primary-blue text-white px-6 py-2 rounded-lg flex-1 primary-blue-hover">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="closeModal('bannerModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Add Year Modal -->
    <div id="addYearModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏û.‡∏®.):</label>
                    <input type="number" id="newAcademicYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="2568">
                </div>
                <div>
                    <label class="block font-medium mb-2">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤:</label>
                    <select id="templateYear" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">-- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà --</option>
                    </select>
                    <div class="text-sm text-gray-600 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="addNewAcademicYear()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex-1">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                </button>
                <button onclick="closeModal('addYearModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Year Admin Panel Modal -->
    <div id="yearAdminModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
            <div id="yearAdminContent"></div>
            <div class="flex gap-4 mt-6">
                <button onclick="closeModal('yearAdminModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Year Confirmation Modal -->
    <div id="deleteYearModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-red-600">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
            <div class="space-y-4">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-800 font-medium mb-2">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span id="deleteYearDisplay" class="font-bold"></span> ?</p>
                    <p class="text-red-700 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á:</p>
                    <ul class="text-red-700 text-sm mt-2 ml-4 list-disc">
                        <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>
                        <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
                        <li>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>
                        <li>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</li>
                    </ul>
                </div>
                <div>
                    <label class="block font-medium mb-2">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:</label>
                    <input type="password" id="deleteYearPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•">
                    <div class="text-sm text-gray-600 mt-1">‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏• ‡∏´‡∏£‡∏∑‡∏≠ master password</div>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="confirmDeleteYear()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                </button>
                <button onclick="closeModal('deleteYearModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Year Modal -->
    <div id="editYearModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
            <div class="space-y-4">
                <div>
                    <label class="block font-medium mb-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏î‡∏¥‡∏°:</label>
                    <input type="text" id="oldYearDisplay" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block font-medium mb-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà (‡∏û.‡∏®.):</label>
                    <input type="number" id="editYearInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="2568">
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-start gap-2">
                        <span class="text-yellow-600 text-lg">‚ö†Ô∏è</span>
                        <div class="text-sm text-yellow-800">
                            <p class="font-medium mb-1">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</p>
                            <p>‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex gap-4 mt-6">
                <button onclick="saveYearEdit()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
                <button onclick="closeModal('editYearModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentClassroom = '';
        let currentAcademicYear = '';
        let classroomData = {};
        let attendanceData = {};
        let behaviorScores = {};
        let disciplinaryRecords = {};
        let passwordAction = '';
        let bannerSettings = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadBannerSettings();
            checkAcademicYear();
        });

        function checkAcademicYear() {
            const savedYear = localStorage.getItem('currentAcademicYear');
            if (savedYear) {
                currentAcademicYear = savedYear;
                initializeMainSystem();
            } else {
                showYearSelectionPage();
            }
        }

        function showYearSelectionPage() {
            document.getElementById('yearSelectionPage').style.display = 'block';
            document.getElementById('mainSystem').style.display = 'none';
            loadYearOptions();
        }

        function loadYearOptions() {
            const yearOptionsDiv = document.getElementById('yearOptions');
            const savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            const currentYear = new Date().getFullYear() + 543;
            
            // If no saved years, create only current year
            if (savedYears.length === 0) {
                savedYears.push({
                    year: currentYear,
                    status: 'current',
                    created: new Date().toISOString()
                });
                localStorage.setItem('academicYears', JSON.stringify(savedYears));
            }
            
            let html = '';
            
            // Admin controls
            html += `
                <div class="col-span-full mb-6">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-semibold text-gray-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
                        <div class="flex gap-2">
                            <button onclick="showAddYearModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
                            </button>
                            <button onclick="showYearAdminPanel()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                ‚öôÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            savedYears.sort((a, b) => b.year - a.year).forEach(yearData => {
                const year = yearData.year;
                const isCurrent = year === currentYear;
                const isPast = year < currentYear;
                const isFuture = year > currentYear;
                
                let statusText = '';
                let statusClass = '';
                let clickable = true;
                
                if (isCurrent) {
                    statusText = '‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
                    statusClass = 'bg-green-100 text-green-800 border-green-300';
                } else if (isPast) {
                    statusText = '‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ';
                    statusClass = 'bg-blue-100 text-blue-800 border-blue-300';
                } else {
                    statusText = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                    statusClass = 'bg-gray-100 text-gray-500 border-gray-300';
                    clickable = false;
                }
                
                html += `
                    <div class="border-2 rounded-lg p-6 text-center transition-all ${statusClass} relative group">
                        <div class="${clickable ? 'cursor-pointer' : 'cursor-not-allowed opacity-60'}" 
                             ${clickable ? `onclick="selectAcademicYear(${year})"` : ''}>
                            <div class="text-3xl font-bold mb-2">${year}</div>
                            <div class="text-sm font-medium mb-2">${statusText}</div>
                            ${isCurrent ? '<div class="text-xs">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>' : ''}
                        </div>
                        
                        <!-- Management buttons -->
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="flex gap-1">
                                <button onclick="editAcademicYear(${year})" class="bg-blue-600 hover:bg-blue-700 text-white p-1 rounded text-xs" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="deleteAcademicYearFromList(${year})" class="bg-red-600 hover:bg-red-700 text-white p-1 rounded text-xs" title="‡∏•‡∏ö">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            yearOptionsDiv.innerHTML = html;
        }

        function selectAcademicYear(year) {
            currentAcademicYear = year;
            localStorage.setItem('currentAcademicYear', year);
            initializeMainSystem();
        }

        function initializeMainSystem() {
            document.getElementById('yearSelectionPage').style.display = 'none';
            document.getElementById('mainSystem').style.display = 'block';
            document.getElementById('currentAcademicYear').textContent = currentAcademicYear;
            
            loadClassrooms();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('attendanceDate').value = today;

            // Load data from localStorage
            loadAllData();
            
            // Load homepage by default
            loadHomepage();
        }

        function showYearSelection() {
            showYearSelectionPage();
        }

        function loadBannerSettings() {
            const saved = localStorage.getItem('bannerSettings');
            if (saved) {
                bannerSettings = JSON.parse(saved);
                applyBannerSettings();
            } else {
                bannerSettings = {
                    backgroundImage: '',
                    logo: 'üè´',
                    directorName: '‡∏ô‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏î‡∏ä ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡πá‡∏á'
                };
            }
        }

        function applyBannerSettings() {
            // Apply to year selection page
            if (bannerSettings.backgroundImage) {
                document.getElementById('yearBanner').style.backgroundImage = `url(${bannerSettings.backgroundImage})`;
                document.getElementById('mainBanner').style.backgroundImage = `url(${bannerSettings.backgroundImage})`;
            }
            
            // Update logo
            const logoElements = [document.getElementById('schoolLogo')];
            logoElements.forEach(element => {
                if (bannerSettings.logoImage) {
                    element.innerHTML = `<img src="${bannerSettings.logoImage}" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-full h-full object-contain">`;
                } else {
                    element.textContent = bannerSettings.logo || 'üè´';
                }
            });
            
            // Update director name
            document.getElementById('directorNameDisplay').textContent = bannerSettings.directorName;
            document.getElementById('directorNameMain').textContent = bannerSettings.directorName;
        }

        function showBannerSettings() {
            document.getElementById('schoolLogoText').value = bannerSettings.logo;
            document.getElementById('directorName').value = bannerSettings.directorName;
            document.getElementById('bannerModal').style.display = 'block';
        }

        function saveBannerSettings() {
            const logoText = document.getElementById('schoolLogoText').value || 'üè´';
            const directorName = document.getElementById('directorName').value || '‡∏ô‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏î‡∏ä ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡πá‡∏á';
            const imageFile = document.getElementById('bannerImage').files[0];
            const logoFile = document.getElementById('schoolLogoFile').files[0];

            bannerSettings.logo = logoText;
            bannerSettings.directorName = directorName;

            let filesToProcess = 0;
            let filesProcessed = 0;

            function checkComplete() {
                filesProcessed++;
                if (filesProcessed === filesToProcess) {
                    localStorage.setItem('bannerSettings', JSON.stringify(bannerSettings));
                    applyBannerSettings();
                    closeModal('bannerModal');
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
            }

            if (imageFile) filesToProcess++;
            if (logoFile) filesToProcess++;
            
            if (filesToProcess === 0) {
                localStorage.setItem('bannerSettings', JSON.stringify(bannerSettings));
                applyBannerSettings();
                closeModal('bannerModal');
                alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                return;
            }

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    bannerSettings.backgroundImage = e.target.result;
                    checkComplete();
                };
                reader.readAsDataURL(imageFile);
            }

            if (logoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    bannerSettings.logoImage = e.target.result;
                    checkComplete();
                };
                reader.readAsDataURL(logoFile);
            }
        }

        function loadAllData() {
            const yearKey = `_${currentAcademicYear}`;
            const savedClassrooms = localStorage.getItem('classroomData' + yearKey);
            const savedAttendance = localStorage.getItem('attendanceData' + yearKey);
            const savedBehavior = localStorage.getItem('behaviorScores' + yearKey);
            const savedDisciplinary = localStorage.getItem('disciplinaryRecords' + yearKey);

            if (savedClassrooms) {
                classroomData = JSON.parse(savedClassrooms);
            } else {
                // Initialize with sample data
                initializeSampleData();
            }

            if (savedAttendance) {
                attendanceData = JSON.parse(savedAttendance);
            }

            if (savedBehavior) {
                behaviorScores = JSON.parse(savedBehavior);
            }

            if (savedDisciplinary) {
                disciplinaryRecords = JSON.parse(savedDisciplinary);
            }

            loadClassrooms();
        }

        function initializeSampleData() {
            const sampleClasses = ['‡∏°.1/1', '‡∏°.1/2', '‡∏°.1/3', '‡∏°.2/1', '‡∏°.2/2', '‡∏°.2/3', '‡∏°.3/1', '‡∏°.3/2', '‡∏°.4', '‡∏°.5/1', '‡∏°.5/2', '‡∏°.6/1', '‡∏°.6/2'];
            
            sampleClasses.forEach((className, index) => {
                classroomData[className] = {
                    level: className,
                    teacher: `‡∏Ñ‡∏£‡∏π${String.fromCharCode(65 + index)} ‡∏™‡∏°‡∏ä‡∏≤‡∏¢`,
                    students: [
                        { id: 1, studentId: '12001', name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', image: '' },
                        { id: 2, studentId: '12002', name: '‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', image: '' },
                        { id: 3, studentId: '12003', name: '‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏Ç‡∏¢‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', image: '' }
                    ]
                };

                // Initialize behavior scores
                classroomData[className].students.forEach(student => {
                    const key = `${className}_${student.studentId}`;
                    if (!behaviorScores[key]) {
                        behaviorScores[key] = {
                            score: 100,
                            history: [],
                            disciplinaryCount: 0
                        };
                    }
                });
            });

            saveAllData();
        }

        function saveAllData() {
            const yearKey = `_${currentAcademicYear}`;
            localStorage.setItem('classroomData' + yearKey, JSON.stringify(classroomData));
            localStorage.setItem('attendanceData' + yearKey, JSON.stringify(attendanceData));
            localStorage.setItem('behaviorScores' + yearKey, JSON.stringify(behaviorScores));
            localStorage.setItem('disciplinaryRecords' + yearKey, JSON.stringify(disciplinaryRecords));
        }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function loadClassrooms() {
            const select = document.getElementById('classroomSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
            
            // Sort classrooms by grade level and section
            const sortedClassrooms = Object.keys(classroomData).sort((a, b) => {
                // Extract grade and section for proper sorting
                const parseClass = (className) => {
                    const match = className.match(/‡∏°\.(\d+)\/(\d+)/);
                    if (match) {
                        return { grade: parseInt(match[1]), section: parseInt(match[2]) };
                    }
                    // Handle special cases like ‡∏°.4
                    const singleMatch = className.match(/‡∏°\.(\d+)$/);
                    if (singleMatch) {
                        return { grade: parseInt(singleMatch[1]), section: 0 };
                    }
                    return { grade: 0, section: 0 };
                };
                
                const aData = parseClass(a);
                const bData = parseClass(b);
                
                if (aData.grade !== bData.grade) {
                    return aData.grade - bData.grade;
                }
                return aData.section - bData.section;
            });
            
            sortedClassrooms.forEach(classroom => {
                const option = document.createElement('option');
                option.value = classroom;
                option.textContent = classroom;
                select.appendChild(option);
            });
        }

        function showSupportSystem() {
            passwordAction = 'supportSystem';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function showClassroomManagement() {
            passwordAction = 'classroomManagement';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function loadSupportSystem() {
            const supportDiv = document.getElementById('supportContent');
            
            let html = '<div class="space-y-6">';
            
            // Period selection
            html += `
                <div class="flex gap-4 items-center mb-6">
                    <label class="font-medium">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
                    <select id="supportPeriod" onchange="updateSupportData()" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
                        <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
                        <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                    </select>
                    <input type="date" id="supportDate" onchange="updateSupportData()" class="px-4 py-2 border border-gray-300 rounded-lg">
                    <button onclick="printSupportReport()" class="primary-blue text-white px-4 py-2 rounded-lg primary-blue-hover">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            `;
            
            html += '<div id="supportDataTable"></div>';
            html += '</div>';
            
            supportDiv.innerHTML = html;
            
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('supportDate').value = today;
            
            updateSupportData();
        }

        function updateSupportData() {
            const period = document.getElementById('supportPeriod').value;
            const selectedDate = document.getElementById('supportDate').value;
            const tableDiv = document.getElementById('supportDataTable');
            
            // Get sorted classrooms
            const sortedClassrooms = Object.keys(classroomData).sort((a, b) => {
                const parseClass = (className) => {
                    const match = className.match(/‡∏°\.(\d+)\/(\d+)/);
                    if (match) {
                        return { grade: parseInt(match[1]), section: parseInt(match[2]) };
                    }
                    const singleMatch = className.match(/‡∏°\.(\d+)$/);
                    if (singleMatch) {
                        return { grade: parseInt(singleMatch[1]), section: 0 };
                    }
                    return { grade: 0, section: 0 };
                };
                
                const aData = parseClass(a);
                const bData = parseClass(b);
                
                if (aData.grade !== bData.grade) {
                    return aData.grade - bData.grade;
                }
                return aData.section - bData.section;
            });
            
            let html = '<div class="overflow-x-auto">';
            html += '<table class="w-full border-collapse border border-gray-300" id="supportReportTable">';
            html += '<thead><tr class="primary-blue text-white">';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏°‡∏≤</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏™‡∏≤‡∏¢</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏•‡∏≤</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤</th>';
            html += '</tr></thead><tbody>';
            
            let totalStudents = 0, totalPresent = 0, totalAbsent = 0, totalLate = 0, totalLeave = 0;
            
            sortedClassrooms.forEach(classroom => {
                const classData = classroomData[classroom];
                const studentCount = classData.students.length;
                totalStudents += studentCount;
                
                let present = 0, absent = 0, late = 0, leave = 0;
                
                // Calculate based on period
                const dates = getDateRange(selectedDate, period);
                
                dates.forEach(date => {
                    classData.students.forEach(student => {
                        const key = `${classroom}_${date}_${student.studentId}`;
                        const status = attendanceData[key];
                        
                        if (status === 'present') present++;
                        else if (status === 'absent') absent++;
                        else if (status === 'late') late++;
                        else if (status === 'leave') leave++;
                    });
                });
                
                totalPresent += present;
                totalAbsent += absent;
                totalLate += late;
                totalLeave += leave;
                
                const totalRecords = present + absent + late + leave;
                const attendanceRate = totalRecords > 0 ? ((present + late) / totalRecords * 100).toFixed(1) : 0;
                
                html += `<tr class="border border-gray-300">`;
                html += `<td class="border border-gray-300 px-4 py-2 font-medium">${classroom}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">${studentCount}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center text-green-600 font-semibold">${present}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center text-red-600 font-semibold">${absent}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center text-orange-600 font-semibold">${late}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center text-yellow-600 font-semibold">${leave}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center font-semibold ${attendanceRate >= 80 ? 'text-green-600' : attendanceRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">${attendanceRate}%</td>`;
                html += `</tr>`;
            });
            
            // Summary row
            const totalRecords = totalPresent + totalAbsent + totalLate + totalLeave;
            const overallRate = totalRecords > 0 ? ((totalPresent + totalLate) / totalRecords * 100).toFixed(1) : 0;
            
            html += `<tr class="bg-gray-100 font-semibold">`;
            html += `<td class="border border-gray-300 px-4 py-2">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>`;
            html += `<td class="border border-gray-300 px-4 py-2 text-center">${totalStudents}</td>`;
            html += `<td class="border border-gray-300 px-4 py-2 text-center text-green-600">${totalPresent}</td>`;
            html += `<td class="border border-gray-300 px-4 py-2 text-center text-red-600">${totalAbsent}</td>`;
            html += `<td class="border border-gray-300 px-4 py-2 text-center text-orange-600">${totalLate}</td>`;
            html += `<td class="border border-gray-300 px-4 py-2 text-center text-yellow-600">${totalLeave}</td>`;
            html += `<td class="border border-gray-300 px-4 py-2 text-center ${overallRate >= 80 ? 'text-green-600' : overallRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">${overallRate}%</td>`;
            html += `</tr>`;
            
            html += '</tbody></table></div>';
            tableDiv.innerHTML = html;
        }

        function getDateRange(selectedDate, period) {
            const dates = [];
            const date = new Date(selectedDate);
            
            if (period === 'daily') {
                dates.push(selectedDate);
            } else if (period === 'weekly') {
                // Get the week containing the selected date
                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - date.getDay());
                
                for (let i = 0; i < 7; i++) {
                    const weekDate = new Date(startOfWeek);
                    weekDate.setDate(startOfWeek.getDate() + i);
                    dates.push(weekDate.toISOString().split('T')[0]);
                }
            } else if (period === 'monthly') {
                // Get all days in the month
                const year = date.getFullYear();
                const month = date.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const monthDate = new Date(year, month, day);
                    dates.push(monthDate.toISOString().split('T')[0]);
                }
            }
            
            return dates;
        }

        function printSupportReport() {
            const table = document.getElementById('supportReportTable').outerHTML;
            const period = document.getElementById('supportPeriod').value;
            const selectedDate = document.getElementById('supportDate').value;
            
            let periodText = '';
            if (period === 'daily') periodText = '‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô';
            else if (period === 'weekly') periodText = '‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå';
            else if (period === 'monthly') periodText = '‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</title>
                    <style>
                        body { font-family: 'Sarabun', sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        th { background-color: #022c8b; color: white; }
                        .header { text-align: center; margin-bottom: 20px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                        <h3>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏á‡∏≠‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</h3>
                        <p>‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${currentAcademicYear} | ${periodText} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date(selectedDate).toLocaleDateString('th-TH')}</p>
                    </div>
                    ${table}
                    <div style="margin-top: 20px; text-align: right;">
                        <p>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printSummaryReport() {
            if (!currentClassroom) return;
            
            const classroom = classroomData[currentClassroom];
            const printWindow = window.open('', '_blank');
            
            // Generate summary data
            const dates = new Set();
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(currentClassroom) && !key.includes('notes')) {
                    const parts = key.split('_');
                    if (parts.length >= 3) {
                        dates.add(parts[1]);
                    }
                }
            });

            const sortedDates = Array.from(dates).sort().reverse();
            
            let summaryTable = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
            summaryTable += '<thead><tr style="background-color: #022c8b; color: white;">';
            summaryTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>';
            summaryTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            summaryTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏™‡∏≤‡∏¢</th>';
            summaryTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            summaryTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏•‡∏≤</th>';
            summaryTable += '<th style="border: 1px solid #000; padding: 8px;">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>';
            summaryTable += '</tr></thead><tbody>';

            classroom.students.forEach(student => {
                let present = 0, absent = 0, leave = 0, late = 0;
                
                sortedDates.forEach(date => {
                    const key = `${currentClassroom}_${date}_${student.studentId}`;
                    const status = attendanceData[key];
                    if (status === 'present') present++;
                    else if (status === 'absent') absent++;
                    else if (status === 'leave') leave++;
                    else if (status === 'late') late++;
                });

                const total = present + absent + leave + late;
                const rate = total > 0 ? ((present + late) / total * 100).toFixed(1) : 0;

                summaryTable += `<tr>`;
                summaryTable += `<td style="border: 1px solid #000; padding: 8px;">${student.name}</td>`;
                summaryTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${present}</td>`;
                summaryTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${late}</td>`;
                summaryTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${absent}</td>`;
                summaryTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${leave}</td>`;
                summaryTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${rate}%</td>`;
                summaryTable += `</tr>`;
            });

            summaryTable += '</tbody></table>';
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
                    <style>
                        body { font-family: 'Sarabun', sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                        <h3>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏á‡∏≠‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</h3>
                        <p>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${currentClassroom} | ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${currentAcademicYear}</p>
                        <p>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤: ${classroom.teacher}</p>
                    </div>
                    ${summaryTable}
                    <div style="margin-top: 20px; text-align: right;">
                        <p>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printBehaviorReport() {
            if (!currentClassroom) return;
            
            const classroom = classroomData[currentClassroom];
            const printWindow = window.open('', '_blank');
            
            let behaviorTable = '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
            behaviorTable += '<thead><tr style="background-color: #022c8b; color: white;">';
            behaviorTable += '<th style="border: 1px solid #000; padding: 8px;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>';
            behaviorTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>';
            behaviorTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</th>';
            behaviorTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</th>';
            behaviorTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            behaviorTable += '<th style="border: 1px solid #000; padding: 8px;">‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</th>';
            behaviorTable += '</tr></thead><tbody>';

            classroom.students.forEach(student => {
                const key = `${currentClassroom}_${student.studentId}`;
                const behaviorData = behaviorScores[key] || { score: 100, history: [], disciplinaryCount: 0 };
                
                const behaviorStatus = behaviorData.score >= 50 ? '‡∏õ‡∏Å‡∏ï‡∏¥' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
                const attendanceStatus = getStudentAttendanceStatus(student.studentId);

                behaviorTable += `<tr>`;
                behaviorTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${student.id}</td>`;
                behaviorTable += `<td style="border: 1px solid #000; padding: 8px;">${student.name}</td>`;
                behaviorTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${behaviorData.score}</td>`;
                behaviorTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${behaviorStatus}</td>`;
                behaviorTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${attendanceStatus}</td>`;
                behaviorTable += `<td style="border: 1px solid #000; padding: 8px; text-align: center;">${behaviorData.disciplinaryCount}/3</td>`;
                behaviorTable += `</tr>`;
            });

            behaviorTable += '</tbody></table>';
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</title>
                    <style>
                        body { font-family: 'Sarabun', sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h2>
                        <h3>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏´‡∏•‡∏°‡∏á‡∏≠‡∏ö‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏°</h3>
                        <p>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${currentClassroom} | ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${currentAcademicYear}</p>
                        <p>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤: ${classroom.teacher}</p>
                    </div>
                    ${behaviorTable}
                    <div style="margin-top: 20px; text-align: right;">
                        <p>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function loadClassroomManagement() {
            const manageDiv = document.getElementById('classroomManageContent');
            
            let html = '<div class="space-y-6">';
            
            // Management controls
            html += `
                <div class="flex justify-between items-center">
                    <div class="flex gap-4 items-center">
                        <label class="font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label>
                        <select id="manageClassroomSelect" onchange="loadSelectedClassroomData()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>
                        </select>
                    </div>
                    <button onclick="showAddNewClassroom()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            `;
            
            html += '<div id="selectedClassroomData"></div>';
            html += '</div>';
            
            manageDiv.innerHTML = html;
            loadClassroomManagementSelect();
        }

        function loadClassroomManagementSelect() {
            const select = document.getElementById('manageClassroomSelect');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• --</option>';
            
            const sortedClassrooms = Object.keys(classroomData).sort((a, b) => {
                const parseClass = (className) => {
                    const match = className.match(/‡∏°\.(\d+)\/(\d+)/);
                    if (match) {
                        return { grade: parseInt(match[1]), section: parseInt(match[2]) };
                    }
                    const singleMatch = className.match(/‡∏°\.(\d+)$/);
                    if (singleMatch) {
                        return { grade: parseInt(singleMatch[1]), section: 0 };
                    }
                    return { grade: 0, section: 0 };
                };
                
                const aData = parseClass(a);
                const bData = parseClass(b);
                
                if (aData.grade !== bData.grade) {
                    return aData.grade - bData.grade;
                }
                return aData.section - bData.section;
            });
            
            sortedClassrooms.forEach(classroom => {
                const option = document.createElement('option');
                option.value = classroom;
                option.textContent = classroom;
                select.appendChild(option);
            });
        }

        function loadClassroom() {
            const selectedClass = document.getElementById('classroomSelect').value;
            if (!selectedClass) return;

            currentClassroom = selectedClass;
            const classroom = classroomData[selectedClass];

            // Show classroom info
            document.getElementById('classroomInfo').style.display = 'block';
            document.getElementById('classLevel').textContent = classroom.level;
            document.getElementById('teacherName').textContent = classroom.teacher;

            // Load student list for attendance
            loadStudentList();
            
            // Load other tabs
            loadSummary();
            loadBehaviorScores();
            loadManageStudents();
        }

        function loadStudentList() {
            if (!currentClassroom) return;

            const classroom = classroomData[currentClassroom];
            const studentListDiv = document.getElementById('studentList');
            const selectedDate = document.getElementById('attendanceDate').value;

            let html = '<div class="responsive-table"><table class="w-full border-collapse border border-gray-300">';
            html += '<thead><tr class="bg-gray-100">';
            html += '<th class="border border-gray-300 px-2 sm:px-4 py-2 text-xs sm:text-sm">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>';
            html += '<th class="border border-gray-300 px-2 sm:px-4 py-2 text-xs sm:text-sm mobile-hidden">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>';
            html += '<th class="border border-gray-300 px-2 sm:px-4 py-2 text-xs sm:text-sm mobile-hidden">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>';
            html += '<th class="border border-gray-300 px-2 sm:px-4 py-2 text-xs sm:text-sm">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>';
            html += '<th class="border border-gray-300 px-2 sm:px-4 py-2 text-xs sm:text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>';
            html += '<th class="border border-gray-300 px-2 sm:px-4 py-2 text-xs sm:text-sm mobile-hidden">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>';
            html += '</tr></thead><tbody>';

            classroom.students.forEach(student => {
                const attendanceKey = `${currentClassroom}_${selectedDate}_${student.studentId}`;
                // Default to 'present' if no status is set
                const currentStatus = attendanceData[attendanceKey] || 'present';
                
                let rowClass = '';
                if (currentStatus === 'present') rowClass = 'status-present';
                else if (currentStatus === 'absent') rowClass = 'status-absent';
                else if (currentStatus === 'leave') rowClass = 'status-leave';
                else if (currentStatus === 'late') rowClass = 'status-late';

                html += `<tr class="border border-gray-300 ${rowClass}" id="row_${student.studentId}">`;
                html += `<td class="border border-gray-300 px-2 sm:px-4 py-2 text-center">`;
                if (student.image) {
                    html += `<img src="${student.image}" alt="${student.name}" class="w-8 h-8 sm:w-12 sm:h-12 rounded-full mx-auto object-cover">`;
                } else {
                    html += `<div class="w-8 h-8 sm:w-12 sm:h-12 rounded-full bg-gray-200 mx-auto flex items-center justify-center text-gray-500 text-xs sm:text-base">üë§</div>`;
                }
                html += `</td>`;
                html += `<td class="border border-gray-300 px-2 sm:px-4 py-2 text-center text-xs sm:text-sm mobile-hidden">${student.id}</td>`;
                html += `<td class="border border-gray-300 px-2 sm:px-4 py-2 text-center text-xs sm:text-sm mobile-hidden">${student.studentId}</td>`;
                html += `<td class="border border-gray-300 px-2 sm:px-4 py-2 text-xs sm:text-sm">
                    <div class="sm:hidden text-xs text-gray-500 mb-1">#${student.id} - ${student.studentId}</div>
                    ${student.name}
                </td>`;
                html += `<td class="border border-gray-300 px-1 sm:px-4 py-2">`;
                html += `<div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-1 sm:gap-2 justify-center">`;
                html += `<button onclick="setAttendanceStatus('${student.studentId}', 'present')" class="px-1 sm:px-3 py-1 rounded text-xs sm:text-sm ${currentStatus === 'present' ? 'bg-green-500 text-white' : 'bg-gray-200'} hover:bg-green-400">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>`;
                html += `<button onclick="setAttendanceStatus('${student.studentId}', 'absent')" class="px-1 sm:px-3 py-1 rounded text-xs sm:text-sm ${currentStatus === 'absent' ? 'bg-red-500 text-white' : 'bg-gray-200'} hover:bg-red-400">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>`;
                html += `<button onclick="setAttendanceStatus('${student.studentId}', 'leave')" class="px-1 sm:px-3 py-1 rounded text-xs sm:text-sm ${currentStatus === 'leave' ? 'bg-yellow-500 text-white' : 'bg-gray-200'} hover:bg-yellow-400">‡∏•‡∏≤</button>`;
                html += `<button onclick="setAttendanceStatus('${student.studentId}', 'late')" class="px-1 sm:px-3 py-1 rounded text-xs sm:text-sm ${currentStatus === 'late' ? 'bg-orange-500 text-white' : 'bg-gray-200'} hover:bg-orange-400">‡∏™‡∏≤‡∏¢</button>`;
                html += `</div>`;
                html += `<div class="sm:hidden mt-2">`;
                html += `<button onclick="editStudentImage('${student.studentId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs w-full">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ</button>`;
                html += `</div>`;
                html += `</td>`;
                html += `<td class="border border-gray-300 px-2 sm:px-4 py-2 text-center mobile-hidden">`;
                html += `<button onclick="editStudentImage('${student.studentId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ</button>`;
                html += `</td></tr>`;
            });

            html += '</tbody></table></div>';
            studentListDiv.innerHTML = html;
        }

        function setAttendanceStatus(studentId, status) {
            const selectedDate = document.getElementById('attendanceDate').value;
            const attendanceKey = `${currentClassroom}_${selectedDate}_${studentId}`;
            
            attendanceData[attendanceKey] = status;
            
            // Update row appearance
            const row = document.getElementById(`row_${studentId}`);
            row.className = row.className.replace(/status-\w+/g, '');
            
            if (status === 'present') row.classList.add('status-present');
            else if (status === 'absent') row.classList.add('status-absent');
            else if (status === 'leave') row.classList.add('status-leave');
            else if (status === 'late') row.classList.add('status-late');

            // Update button states
            const buttons = row.querySelectorAll('button');
            buttons.forEach(btn => {
                if (btn.textContent.includes('‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') || btn.textContent.includes('‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') || 
                    btn.textContent.includes('‡∏•‡∏≤') || btn.textContent.includes('‡∏™‡∏≤‡∏¢')) {
                    btn.className = btn.className.replace(/bg-(green|red|yellow|orange)-500 text-white/, 'bg-gray-200');
                }
            });
            
            const activeButton = Array.from(buttons).find(btn => 
                (status === 'present' && btn.textContent === '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') ||
                (status === 'absent' && btn.textContent === '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô') ||
                (status === 'leave' && btn.textContent === '‡∏•‡∏≤') ||
                (status === 'late' && btn.textContent === '‡∏™‡∏≤‡∏¢')
            );
            
            if (activeButton) {
                if (status === 'present') activeButton.className = activeButton.className.replace('bg-gray-200', 'bg-green-500 text-white');
                else if (status === 'absent') activeButton.className = activeButton.className.replace('bg-gray-200', 'bg-red-500 text-white');
                else if (status === 'leave') activeButton.className = activeButton.className.replace('bg-gray-200', 'bg-yellow-500 text-white');
                else if (status === 'late') activeButton.className = activeButton.className.replace('bg-gray-200', 'bg-orange-500 text-white');
            }

            // Don't auto-save, wait for manual save
        }

        function editStudentImage(studentId) {
            const classroom = classroomData[currentClassroom];
            const student = classroom.students.find(s => s.studentId === studentId);

            const content = `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                    <div class="text-center">
                        <div class="mb-4">
                            <strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${student.name}
                        </div>
                        <div class="mb-4">
                            ${student.image ? 
                                `<img src="${student.image}" alt="Current" class="w-32 h-32 rounded-full mx-auto object-cover border-4 border-gray-200">` : 
                                `<div class="w-32 h-32 rounded-full bg-gray-200 mx-auto flex items-center justify-center text-gray-500 text-4xl">üë§</div>`
                            }
                        </div>
                    </div>
                    <div>
                        <label class="block font-medium mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà:</label>
                        <input type="file" id="studentImageFile" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <div class="text-sm text-gray-600 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB</div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="saveStudentImage('${studentId}')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button onclick="removeStudentImage('${studentId}')" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg flex-1">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
                        <button onclick="closeModal('editStudentModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            `;

            document.getElementById('editStudentContent').innerHTML = content;
            document.getElementById('editStudentModal').style.display = 'block';
        }

        function saveStudentImage(studentId) {
            const imageFile = document.getElementById('studentImageFile').files[0];
            
            if (!imageFile) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
                return;
            }

            if (imageFile.size > 5 * 1024 * 1024) {
                alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5MB)');
                return;
            }

            const classroom = classroomData[currentClassroom];
            const studentIndex = classroom.students.findIndex(s => s.studentId === studentId);
            
            if (studentIndex !== -1) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    classroom.students[studentIndex].image = e.target.result;
                    saveAllData();
                    loadStudentList();
                    closeModal('editStudentModal');
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                };
                reader.readAsDataURL(imageFile);
            }
        }

        function removeStudentImage(studentId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                const classroom = classroomData[currentClassroom];
                const studentIndex = classroom.students.findIndex(s => s.studentId === studentId);
                
                if (studentIndex !== -1) {
                    classroom.students[studentIndex].image = '';
                    saveAllData();
                    loadStudentList();
                    closeModal('editStudentModal');
                    alert('‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
            }
        }

        function showAddYearModal() {
            passwordAction = 'addYear';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function showYearAdminPanel() {
            passwordAction = 'yearAdmin';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function loadAddYearModal() {
            // Load template year options
            const templateSelect = document.getElementById('templateYear');
            templateSelect.innerHTML = '<option value="">-- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà --</option>';
            
            const savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            savedYears.sort((a, b) => b.year - a.year).forEach(yearData => {
                const option = document.createElement('option');
                option.value = yearData.year;
                option.textContent = `‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${yearData.year}`;
                templateSelect.appendChild(option);
            });
            
            document.getElementById('addYearModal').style.display = 'block';
        }

        function addNewAcademicYear() {
            const newYear = parseInt(document.getElementById('newAcademicYear').value);
            const templateYear = document.getElementById('templateYear').value;
            
            if (!newYear) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
                return;
            }
            
            // Check if year already exists
            const savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            if (savedYears.some(y => y.year === newYear)) {
                alert('‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            
            // Add new year
            savedYears.push({
                year: newYear,
                status: 'future',
                created: new Date().toISOString()
            });
            localStorage.setItem('academicYears', JSON.stringify(savedYears));
            
            // Copy data from template if selected
            if (templateYear) {
                const templateKey = `_${templateYear}`;
                const newKey = `_${newYear}`;
                
                const templateClassrooms = localStorage.getItem('classroomData' + templateKey);
                if (templateClassrooms) {
                    localStorage.setItem('classroomData' + newKey, templateClassrooms);
                }
                
                // Initialize empty attendance and behavior data
                localStorage.setItem('attendanceData' + newKey, '{}');
                const templateBehavior = localStorage.getItem('behaviorScores' + templateKey);
                if (templateBehavior) {
                    // Reset behavior scores to default
                    const behaviorData = JSON.parse(templateBehavior);
                    Object.keys(behaviorData).forEach(key => {
                        behaviorData[key] = {
                            score: 100,
                            history: [],
                            disciplinaryCount: 0
                        };
                    });
                    localStorage.setItem('behaviorScores' + newKey, JSON.stringify(behaviorData));
                }
                localStorage.setItem('disciplinaryRecords' + newKey, '{}');
            }
            
            closeModal('addYearModal');
            loadYearOptions();
            alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function loadYearAdminPanel() {
            const savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            const content = document.getElementById('yearAdminContent');
            
            let html = '<div class="space-y-6">';
            
            // Add new year section
            html += `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-semibold text-green-800 mb-3">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà</h4>
                    <div class="flex gap-3 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏û.‡∏®.):</label>
                            <input type="number" id="quickAddYear" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="2569" min="2500" max="2600">
                        </div>
                        <button onclick="quickAddYear()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°
                        </button>
                    </div>
                </div>
            `;
            
            // Existing years table
            html += '<div>';
            html += '<h4 class="font-semibold mb-3">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>';
            
            if (savedYears.length === 0) {
                html += '<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>';
            } else {
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full border-collapse border border-gray-300">';
                html += '<thead><tr class="bg-gray-100">';
                html += '<th class="border border-gray-300 px-4 py-2">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>';
                html += '<th class="border border-gray-300 px-4 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>';
                html += '<th class="border border-gray-300 px-4 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>';
                html += '<th class="border border-gray-300 px-4 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>';
                html += '</tr></thead><tbody>';
                
                savedYears.sort((a, b) => b.year - a.year).forEach(yearData => {
                    const currentYear = new Date().getFullYear() + 543;
                    let statusText = '';
                    let statusClass = '';
                    
                    if (yearData.year === currentYear) {
                        statusText = '‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';
                        statusClass = 'text-green-600 bg-green-100';
                    } else if (yearData.year < currentYear) {
                        statusText = '‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤';
                        statusClass = 'text-blue-600 bg-blue-100';
                    } else {
                        statusText = '‡∏õ‡∏µ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï';
                        statusClass = 'text-gray-600 bg-gray-100';
                    }
                    
                    html += `<tr>`;
                    html += `<td class="border border-gray-300 px-4 py-2 text-center font-semibold">${yearData.year}</td>`;
                    html += `<td class="border border-gray-300 px-4 py-2 text-center"><span class="px-2 py-1 rounded text-sm ${statusClass}">${statusText}</span></td>`;
                    html += `<td class="border border-gray-300 px-4 py-2 text-center">${new Date(yearData.created).toLocaleDateString('th-TH')}</td>`;
                    html += `<td class="border border-gray-300 px-4 py-2 text-center">`;
                    html += `<button onclick="showDeleteYearConfirmation(${yearData.year})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">üóëÔ∏è ‡∏•‡∏ö</button>`;
                    html += `</td>`;
                    html += `</tr>`;
                });
                
                html += '</tbody></table></div>';
            }
            
            html += '</div></div>';
            content.innerHTML = html;
            
            document.getElementById('yearAdminModal').style.display = 'block';
        }

        function quickAddYear() {
            const yearInput = document.getElementById('quickAddYear');
            const newYear = parseInt(yearInput.value);
            
            if (!newYear) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
                return;
            }
            
            if (newYear < 2500 || newYear > 2600) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (2500-2600)');
                return;
            }
            
            // Check if year already exists
            const savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            if (savedYears.some(y => y.year === newYear)) {
                alert('‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                yearInput.value = '';
                return;
            }
            
            // Add new year
            savedYears.push({
                year: newYear,
                status: 'future',
                created: new Date().toISOString()
            });
            localStorage.setItem('academicYears', JSON.stringify(savedYears));
            
            // Initialize empty data for new year
            const newKey = `_${newYear}`;
            localStorage.setItem('classroomData' + newKey, '{}');
            localStorage.setItem('attendanceData' + newKey, '{}');
            localStorage.setItem('behaviorScores' + newKey, '{}');
            localStorage.setItem('disciplinaryRecords' + newKey, '{}');
            
            yearInput.value = '';
            loadYearAdminPanel(); // Reload the panel
            loadYearOptions(); // Update year selection page
            alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function showDeleteYearConfirmation(year) {
            window.yearToDelete = year;
            document.getElementById('deleteYearDisplay').textContent = year;
            document.getElementById('deleteYearPassword').value = '';
            document.getElementById('deleteYearModal').style.display = 'block';
        }

        function confirmDeleteYear() {
            const password = document.getElementById('deleteYearPassword').value;
            const masterPassword = 'lklk';
            const adminPassword = 'lkadmin';
            
            if (password !== masterPassword && password !== adminPassword) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ');
                return;
            }
            
            const year = window.yearToDelete;
            
            // Remove from years list
            let savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            savedYears = savedYears.filter(y => y.year !== year);
            localStorage.setItem('academicYears', JSON.stringify(savedYears));
            
            // Remove all data for this year
            const yearKey = `_${year}`;
            localStorage.removeItem('classroomData' + yearKey);
            localStorage.removeItem('attendanceData' + yearKey);
            localStorage.removeItem('behaviorScores' + yearKey);
            localStorage.removeItem('disciplinaryRecords' + yearKey);
            
            // If this was the current year, reset to year selection
            if (currentAcademicYear == year) {
                localStorage.removeItem('currentAcademicYear');
                showYearSelectionPage();
            }
            
            // Clean up
            delete window.yearToDelete;
            
            closeModal('deleteYearModal');
            loadYearAdminPanel(); // Reload the panel
            loadYearOptions(); // Update year selection page
            alert('‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function deleteAcademicYear(year) {
            showDeleteYearConfirmation(year);
        }

        function deleteAcademicYearFromList(year) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${year} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ`)) {
                // Store year to delete and show password modal
                window.yearToDelete = year;
                passwordAction = 'deleteYear';
                document.getElementById('passwordModal').style.display = 'block';
            }
        }

        function editAcademicYear(year) {
            // Store the year being edited
            window.yearToEdit = year;
            
            // Fill the form
            document.getElementById('oldYearDisplay').value = year;
            document.getElementById('editYearInput').value = year;
            
            // Show the edit modal
            document.getElementById('editYearModal').style.display = 'block';
        }

        function saveYearEdit() {
            const oldYear = window.yearToEdit;
            const newYear = parseInt(document.getElementById('editYearInput').value);
            
            if (!newYear) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà');
                return;
            }
            
            if (oldYear === newYear) {
                alert('‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°');
                return;
            }
            
            // Check if new year already exists
            const savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            if (savedYears.some(y => y.year === newYear)) {
                alert('‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }
            
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å ${oldYear} ‡πÄ‡∏õ‡πá‡∏ô ${newYear} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`)) {
                // Update years list
                const yearIndex = savedYears.findIndex(y => y.year === oldYear);
                if (yearIndex !== -1) {
                    savedYears[yearIndex].year = newYear;
                    localStorage.setItem('academicYears', JSON.stringify(savedYears));
                }
                
                // Move all data from old year to new year
                const oldKey = `_${oldYear}`;
                const newKey = `_${newYear}`;
                
                const dataTypes = ['classroomData', 'attendanceData', 'behaviorScores', 'disciplinaryRecords'];
                dataTypes.forEach(dataType => {
                    const oldData = localStorage.getItem(dataType + oldKey);
                    if (oldData) {
                        localStorage.setItem(dataType + newKey, oldData);
                        localStorage.removeItem(dataType + oldKey);
                    }
                });
                
                // Update current year if it was the one being edited
                if (currentAcademicYear == oldYear) {
                    currentAcademicYear = newYear;
                    localStorage.setItem('currentAcademicYear', newYear);
                    document.getElementById('currentAcademicYear').textContent = newYear;
                }
                
                // Clean up
                delete window.yearToEdit;
                
                closeModal('editYearModal');
                loadYearOptions();
                alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        function executeDeleteYear() {
            const year = window.yearToDelete;
            
            // Remove from years list
            let savedYears = JSON.parse(localStorage.getItem('academicYears') || '[]');
            savedYears = savedYears.filter(y => y.year !== year);
            localStorage.setItem('academicYears', JSON.stringify(savedYears));
            
            // Remove all data for this year
            const yearKey = `_${year}`;
            localStorage.removeItem('classroomData' + yearKey);
            localStorage.removeItem('attendanceData' + yearKey);
            localStorage.removeItem('behaviorScores' + yearKey);
            localStorage.removeItem('disciplinaryRecords' + yearKey);
            
            // Clean up
            delete window.yearToDelete;
            
            loadYearAdminPanel();
            loadYearOptions();
            alert('‡∏•‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function saveAttendance() {
            if (!currentClassroom) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
                return;
            }

            const selectedDate = document.getElementById('attendanceDate').value;
            const notes = document.getElementById('behaviorNotes').value;
            const classroom = classroomData[currentClassroom];

            // Ensure all students have attendance status (default to present if not set)
            classroom.students.forEach(student => {
                const attendanceKey = `${currentClassroom}_${selectedDate}_${student.studentId}`;
                if (!attendanceData[attendanceKey]) {
                    attendanceData[attendanceKey] = 'present';
                }
            });

            // Save notes
            const notesKey = `${currentClassroom}_${selectedDate}_notes`;
            attendanceData[notesKey] = notes;

            // Calculate attendance summary
            let present = 0, absent = 0, leave = 0, late = 0;
            
            classroom.students.forEach(student => {
                const attendanceKey = `${currentClassroom}_${selectedDate}_${student.studentId}`;
                const status = attendanceData[attendanceKey];
                
                if (status === 'present') present++;
                else if (status === 'absent') absent++;
                else if (status === 'leave') leave++;
                else if (status === 'late') late++;
            });

            const total = classroom.students.length;
            const attendanceRate = total > 0 ? ((present + late) / total * 100).toFixed(1) : 0;

            // Show success modal
            const summaryDiv = document.getElementById('successSummary');
            summaryDiv.innerHTML = `
                <div class="text-left">
                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(selectedDate).toLocaleDateString('th-TH')}</p>
                    <p><strong>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${currentClassroom}</p>
                    <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${total} ‡∏Ñ‡∏ô</p>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <p class="text-green-600"><strong>‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${present} ‡∏Ñ‡∏ô</p>
                        <p class="text-orange-600"><strong>‡∏™‡∏≤‡∏¢:</strong> ${late} ‡∏Ñ‡∏ô</p>
                        <p class="text-red-600"><strong>‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${absent} ‡∏Ñ‡∏ô</p>
                        <p class="text-yellow-600"><strong>‡∏•‡∏≤:</strong> ${leave} ‡∏Ñ‡∏ô</p>
                    </div>
                    <p class="mt-2 text-lg"><strong>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> <span class="text-blue-600">${attendanceRate}%</span></p>
                    <div class="mt-3 p-2 bg-blue-50 rounded text-sm">
                        <strong>üí° ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà
                    </div>
                </div>
            `;

            saveAllData();
            document.getElementById('successModal').style.display = 'block';
        }

        function loadSummary() {
            if (!currentClassroom) return;

            const classroom = classroomData[currentClassroom];
            const summaryDiv = document.getElementById('summaryContent');

            let html = '<div class="space-y-6">';
            
            // Add print button
            html += `
                <div class="flex justify-end mb-4">
                    <button onclick="printSummaryReport()" class="primary-blue text-white px-4 py-2 rounded-lg primary-blue-hover">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
            `;
            
            // Get all dates with attendance data
            const dates = new Set();
            Object.keys(attendanceData).forEach(key => {
                if (key.startsWith(currentClassroom) && !key.includes('notes')) {
                    const parts = key.split('_');
                    if (parts.length >= 3) {
                        dates.add(parts[1]);
                    }
                }
            });

            const sortedDates = Array.from(dates).sort().reverse();

            if (sortedDates.length === 0) {
                html += '<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</p>';
            } else {
                // Overall summary
                let totalPresent = 0, totalAbsent = 0, totalLeave = 0, totalLate = 0;
                
                classroom.students.forEach(student => {
                    sortedDates.forEach(date => {
                        const key = `${currentClassroom}_${date}_${student.studentId}`;
                        const status = attendanceData[key];
                        if (status === 'present') totalPresent++;
                        else if (status === 'absent') totalAbsent++;
                        else if (status === 'leave') totalLeave++;
                        else if (status === 'late') totalLate++;
                    });
                });

                const totalRecords = totalPresent + totalAbsent + totalLeave + totalLate;
                const overallRate = totalRecords > 0 ? ((totalPresent + totalLate) / totalRecords * 100).toFixed(1) : 0;

                html += `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600">${totalPresent}</div>
                                <div class="text-sm text-gray-600">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600">${totalLate}</div>
                                <div class="text-sm text-gray-600">‡∏™‡∏≤‡∏¢</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-red-600">${totalAbsent}</div>
                                <div class="text-sm text-gray-600">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-yellow-600">${totalLeave}</div>
                                <div class="text-sm text-gray-600">‡∏•‡∏≤</div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <span class="text-lg font-semibold">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏°: </span>
                            <span class="text-xl font-bold text-blue-600">${overallRate}%</span>
                        </div>
                    </div>
                `;

                // Individual student summary
                html += '<div class="bg-white border rounded-lg overflow-hidden">';
                html += '<h4 class="font-semibold p-4 bg-gray-50 border-b">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h4>';
                html += '<div class="overflow-x-auto">';
                html += '<table class="w-full">';
                html += '<thead><tr class="bg-gray-100">';
                html += '<th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>';
                html += '<th class="px-4 py-2 text-center">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
                html += '<th class="px-4 py-2 text-center">‡∏™‡∏≤‡∏¢</th>';
                html += '<th class="px-4 py-2 text-center">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
                html += '<th class="px-4 py-2 text-center">‡∏•‡∏≤</th>';
                html += '<th class="px-4 py-2 text-center">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>';
                html += '</tr></thead><tbody>';

                classroom.students.forEach(student => {
                    let present = 0, absent = 0, leave = 0, late = 0;
                    
                    sortedDates.forEach(date => {
                        const key = `${currentClassroom}_${date}_${student.studentId}`;
                        const status = attendanceData[key];
                        if (status === 'present') present++;
                        else if (status === 'absent') absent++;
                        else if (status === 'leave') leave++;
                        else if (status === 'late') late++;
                    });

                    const total = present + absent + leave + late;
                    const rate = total > 0 ? ((present + late) / total * 100).toFixed(1) : 0;

                    html += `<tr class="border-t">`;
                    html += `<td class="px-4 py-2">${student.name}</td>`;
                    html += `<td class="px-4 py-2 text-center text-green-600 font-semibold">${present}</td>`;
                    html += `<td class="px-4 py-2 text-center text-orange-600 font-semibold">${late}</td>`;
                    html += `<td class="px-4 py-2 text-center text-red-600 font-semibold">${absent}</td>`;
                    html += `<td class="px-4 py-2 text-center text-yellow-600 font-semibold">${leave}</td>`;
                    html += `<td class="px-4 py-2 text-center font-semibold ${rate >= 80 ? 'text-green-600' : rate >= 60 ? 'text-yellow-600' : 'text-red-600'}">${rate}%</td>`;
                    html += `</tr>`;
                });

                html += '</tbody></table></div></div>';

                // Daily records
                html += '<div class="bg-white border rounded-lg overflow-hidden">';
                html += '<h4 class="font-semibold p-4 bg-gray-50 border-b">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h4>';
                html += '<div class="space-y-4 p-4">';

                sortedDates.forEach(date => {
                    let dayPresent = 0, dayAbsent = 0, dayLeave = 0, dayLate = 0;
                    
                    classroom.students.forEach(student => {
                        const key = `${currentClassroom}_${date}_${student.studentId}`;
                        const status = attendanceData[key];
                        if (status === 'present') dayPresent++;
                        else if (status === 'absent') dayAbsent++;
                        else if (status === 'leave') dayLeave++;
                        else if (status === 'late') dayLate++;
                    });

                    const dayTotal = classroom.students.length;
                    const dayRate = dayTotal > 0 ? ((dayPresent + dayLate) / dayTotal * 100).toFixed(1) : 0;
                    const notesKey = `${currentClassroom}_${date}_notes`;
                    const notes = attendanceData[notesKey] || '';

                    html += `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-medium">${new Date(date).toLocaleDateString('th-TH')}</h5>
                                <span class="text-sm font-semibold ${dayRate >= 80 ? 'text-green-600' : dayRate >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${dayRate}%
                                </span>
                            </div>
                            <div class="grid grid-cols-4 gap-4 text-sm">
                                <div class="text-center">
                                    <div class="font-semibold text-green-600">${dayPresent}</div>
                                    <div class="text-gray-600">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-orange-600">${dayLate}</div>
                                    <div class="text-gray-600">‡∏™‡∏≤‡∏¢</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-red-600">${dayAbsent}</div>
                                    <div class="text-gray-600">‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
                                </div>
                                <div class="text-center">
                                    <div class="font-semibold text-yellow-600">${dayLeave}</div>
                                    <div class="text-gray-600">‡∏•‡∏≤</div>
                                </div>
                            </div>
                            ${notes ? `<div class="mt-3 p-2 bg-gray-50 rounded text-sm"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${notes}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div></div>';
            }

            html += '</div>';
            summaryDiv.innerHTML = html;
        }

        function loadBehaviorScores() {
            if (!currentClassroom) return;

            const classroom = classroomData[currentClassroom];
            const behaviorDiv = document.getElementById('behaviorContent');

            let html = '<div class="space-y-4">';
            
            // Add print button
            html += `
                <div class="flex justify-end">
                    <button onclick="printBehaviorReport()" class="primary-blue text-white px-4 py-2 rounded-lg primary-blue-hover">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°
                    </button>
                </div>
            `;
            
            html += '<div class="overflow-x-auto">';
            html += '<table class="w-full border-collapse border border-gray-300">';
            html += '<thead><tr class="bg-gray-100">';
            html += '<th class="border border-gray-300 px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>';
            html += '</tr></thead><tbody>';

            classroom.students.forEach(student => {
                const key = `${currentClassroom}_${student.studentId}`;
                const behaviorData = behaviorScores[key] || { score: 100, history: [], disciplinaryCount: 0 };
                
                // Behavior status
                const behaviorStatus = behaviorData.score >= 50 ? '‡∏õ‡∏Å‡∏ï‡∏¥' : '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
                const behaviorStatusClass = behaviorData.score >= 50 ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';

                // Attendance status - check recent attendance
                const attendanceStatus = getStudentAttendanceStatus(student.studentId);
                const attendanceStatusClass = attendanceStatus === '‡∏õ‡∏Å‡∏ï‡∏¥' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';

                html += `<tr class="border border-gray-300">`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">${student.id}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2">${student.name}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center font-semibold">${behaviorData.score}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center"><span class="px-2 py-1 rounded text-sm ${behaviorStatusClass}">${behaviorStatus}</span></td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center"><span class="px-2 py-1 rounded text-sm ${attendanceStatusClass}">${attendanceStatus}</span></td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">${behaviorData.disciplinaryCount}/3</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">`;
                html += `<select onchange="showStudentHistory('${student.studentId}', this.value)" class="px-2 py-1 border rounded text-sm">`;
                html += `<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π...</option>`;
                html += `<option value="history">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</option>`;
                html += `<option value="disciplinary">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</option>`;
                html += `</select>`;
                html += `</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table></div></div>';
            behaviorDiv.innerHTML = html;
        }

        function getStudentAttendanceStatus(studentId) {
            // Check last 7 days of attendance
            const today = new Date();
            let absentCount = 0;
            let totalDays = 0;

            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(today.getDate() - i);
                const dateStr = checkDate.toISOString().split('T')[0];
                
                const attendanceKey = `${currentClassroom}_${dateStr}_${studentId}`;
                const status = attendanceData[attendanceKey];
                
                if (status) {
                    totalDays++;
                    if (status === 'absent') {
                        absentCount++;
                    }
                }
            }

            // If absent more than 30% of recorded days, mark as irregular
            if (totalDays > 0 && (absentCount / totalDays) > 0.3) {
                return '‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥';
            }
            return '‡∏õ‡∏Å‡∏ï‡∏¥';
        }

        function loadManageStudents() {
            if (!currentClassroom) return;

            const classroom = classroomData[currentClassroom];
            const manageDiv = document.getElementById('manageContent');

            let html = '<div class="space-y-4">';
            html += '<div class="flex justify-between items-center">';
            html += '<h4 class="text-lg font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>';
            html += '<button onclick="addStudent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>';
            html += '</div>';

            html += '<div class="overflow-x-auto">';
            html += '<table class="w-full border-collapse border border-gray-300">';
            html += '<thead><tr class="bg-gray-100">';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>';
            html += '<th class="border border-gray-300 px-4 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>';
            html += '</tr></thead><tbody>';

            classroom.students.forEach(student => {
                html += `<tr class="border border-gray-300">`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">`;
                if (student.image) {
                    html += `<img src="${student.image}" alt="${student.name}" class="w-12 h-12 rounded-full mx-auto object-cover">`;
                } else {
                    html += `<div class="w-12 h-12 rounded-full bg-gray-200 mx-auto flex items-center justify-center text-gray-500">üë§</div>`;
                }
                html += `</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">${student.id}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">${student.studentId}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2">${student.name}</td>`;
                html += `<td class="border border-gray-300 px-4 py-2 text-center">`;
                html += `<button onclick="editStudent('${student.studentId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm mr-2">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`;
                html += `<button onclick="deleteStudent('${student.studentId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">‡∏•‡∏ö</button>`;
                html += `</td>`;
                html += `</tr>`;
            });

            html += '</tbody></table></div></div>';
            manageDiv.innerHTML = html;
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-200');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active', 'bg-blue-600', 'text-white');
            event.target.classList.remove('bg-gray-200');

            // Show/hide classroom selection based on tab
            const classroomDiv = document.getElementById('classroomSelectionDiv');
            if (tabName === 'attendance' || tabName === 'summary' || tabName === 'behavior') {
                classroomDiv.style.display = 'block';
            } else {
                classroomDiv.style.display = 'none';
            }

            // Reload data for the tab
            if (tabName === 'homepage') loadHomepage();
            else if (tabName === 'summary') loadSummary();
            else if (tabName === 'behavior') loadBehaviorScores();
            else if (tabName === 'manage') loadManageStudents();
        }

        function loadHomepage() {
            // Calculate overall statistics
            let totalStudents = 0;
            let totalPresent = 0, totalAbsent = 0, totalLate = 0, totalLeave = 0;
            
            // Get today's date for recent data
            const today = new Date().toISOString().split('T')[0];
            
            Object.keys(classroomData).forEach(classroom => {
                const classData = classroomData[classroom];
                totalStudents += classData.students.length;
                
                classData.students.forEach(student => {
                    const key = `${classroom}_${today}_${student.studentId}`;
                    const status = attendanceData[key];
                    
                    if (status === 'present') totalPresent++;
                    else if (status === 'absent') totalAbsent++;
                    else if (status === 'late') totalLate++;
                    else if (status === 'leave') totalLeave++;
                });
            });
            
            const totalRecords = totalPresent + totalAbsent + totalLate + totalLeave;
            
            // Update statistics
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('presentCount').textContent = totalPresent;
            document.getElementById('absentCount').textContent = totalAbsent;
            document.getElementById('lateCount').textContent = totalLate;
            document.getElementById('leaveCount').textContent = totalLeave;
            
            // Calculate percentages
            if (totalRecords > 0) {
                document.getElementById('presentPercent').textContent = ((totalPresent / totalRecords) * 100).toFixed(1) + '%';
                document.getElementById('absentPercent').textContent = ((totalAbsent / totalRecords) * 100).toFixed(1) + '%';
                document.getElementById('latePercent').textContent = ((totalLate / totalRecords) * 100).toFixed(1) + '%';
                document.getElementById('leavePercent').textContent = ((totalLeave / totalRecords) * 100).toFixed(1) + '%';
            }
            
            // Update last update date
            document.getElementById('lastUpdateDate').textContent = new Date().toLocaleDateString('th-TH');
            
            // Draw pie chart
            drawPieChart(totalPresent, totalAbsent, totalLate, totalLeave);
        }

        function drawPieChart(present, absent, late, leave) {
            const canvas = document.getElementById('attendanceChart');
            const ctx = canvas.getContext('2d');
            
            // Make canvas responsive
            const isMobile = window.innerWidth < 640;
            const size = isMobile ? 250 : 300;
            canvas.width = size;
            canvas.height = size;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = isMobile ? 100 : 120;
            
            const total = present + absent + late + leave;
            if (total === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', centerX, centerY);
                return;
            }
            
            const data = [
                { label: '‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', value: present, color: '#10b981' },
                { label: '‡∏Ç‡∏≤‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', value: absent, color: '#ef4444' },
                { label: '‡∏™‡∏≤‡∏¢', value: late, color: '#f97316' },
                { label: '‡∏•‡∏≤', value: leave, color: '#eab308' }
            ];
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let currentAngle = -Math.PI / 2;
            
            data.forEach(item => {
                if (item.value > 0) {
                    const sliceAngle = (item.value / total) * 2 * Math.PI;
                    
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    ctx.closePath();
                    ctx.fillStyle = item.color;
                    ctx.fill();
                    
                    // Add hover effect (simplified)
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    currentAngle += sliceAngle;
                }
            });
            
            // Update legend
            const legend = document.getElementById('chartLegend');
            legend.innerHTML = '';
            data.forEach(item => {
                if (item.value > 0) {
                    const percent = ((item.value / total) * 100).toFixed(1);
                    legend.innerHTML += `
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded" style="background-color: ${item.color}"></div>
                            <span>${item.label}: ${item.value} (${percent}%)</span>
                        </div>
                    `;
                }
            });
        }

        function showAddClassroom() {
            passwordAction = 'addClassroom';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function showBehaviorManagement() {
            passwordAction = 'behaviorManagement';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const masterPassword = 'lklk';
            let correctPassword = '';
            
            if (passwordAction === 'addClassroom' || passwordAction === 'supportSystem' || passwordAction === 'classroomManagement' || passwordAction === 'addYear' || passwordAction === 'yearAdmin' || passwordAction === 'deleteYear') {
                correctPassword = 'lkadmin';
            } else if (passwordAction === 'behaviorManagement') {
                correctPassword = 'lkcare';
            } else if (passwordAction === 'deleteHistory') {
                correctPassword = 'lkcare';
            }
            
            if (password === correctPassword || password === masterPassword) {
                closeModal('passwordModal');
                document.getElementById('passwordInput').value = '';
                
                if (passwordAction === 'addClassroom') {
                    document.getElementById('addClassroomModal').style.display = 'block';
                } else if (passwordAction === 'behaviorManagement') {
                    showBehaviorModal();
                } else if (passwordAction === 'supportSystem') {
                    showTab('support');
                    loadSupportSystem();
                } else if (passwordAction === 'classroomManagement') {
                    showTab('classroomManage');
                    loadClassroomManagement();
                } else if (passwordAction === 'deleteHistory') {
                    executeDeleteHistory();
                } else if (passwordAction === 'addYear') {
                    loadAddYearModal();
                } else if (passwordAction === 'yearAdmin') {
                    loadYearAdminPanel();
                } else if (passwordAction === 'deleteYear') {
                    executeDeleteYear();
                }
            } else {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
        }

        function showBehaviorModal() {
            if (!currentClassroom) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            const classroom = classroomData[currentClassroom];
            const modalContent = document.getElementById('behaviorModalContent');

            let html = '<div class="space-y-4">';
            html += '<div class="flex gap-4 mb-4">';
            html += '<button onclick="showScoreManagement()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>';
            html += '<button onclick="showDisciplinaryManagement()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</button>';
            html += '</div>';

            html += '<div id="behaviorManagementContent"></div>';
            html += '<div class="flex gap-4 mt-6">';
            html += '<button onclick="closeModal(\'behaviorModal\')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">‡∏õ‡∏¥‡∏î</button>';
            html += '</div>';
            html += '</div>';

            modalContent.innerHTML = html;
            document.getElementById('behaviorModal').style.display = 'block';
            showScoreManagement();
        }

        function showScoreManagement() {
            const classroom = classroomData[currentClassroom];
            const content = document.getElementById('behaviorManagementContent');

            let html = '<h4 class="font-semibold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°</h4>';
            html += '<div class="space-y-3">';

            classroom.students.forEach(student => {
                const key = `${currentClassroom}_${student.studentId}`;
                const behaviorData = behaviorScores[key] || { score: 100, history: [], disciplinaryCount: 0 };

                html += `<div class="flex items-center justify-between p-3 border rounded-lg">`;
                html += `<div>`;
                html += `<span class="font-medium">${student.name}</span>`;
                html += `<span class="ml-2 text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${behaviorData.score}</span>`;
                html += `</div>`;
                html += `<div class="flex gap-2">`;
                html += `<input type="number" id="score_${student.studentId}" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô" class="w-20 px-2 py-1 border rounded text-sm">`;
                html += `<input type="text" id="reason_${student.studentId}" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•" class="w-32 px-2 py-1 border rounded text-sm">`;
                html += `<button onclick="addScore('${student.studentId}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>`;
                html += `<button onclick="deductScore('${student.studentId}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">‡∏´‡∏±‡∏Å</button>`;
                html += `</div>`;
                html += `</div>`;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function showDisciplinaryManagement() {
            const classroom = classroomData[currentClassroom];
            const content = document.getElementById('behaviorManagementContent');

            let html = '<h4 class="font-semibold mb-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</h4>';
            html += '<div class="space-y-3">';

            classroom.students.forEach(student => {
                const key = `${currentClassroom}_${student.studentId}`;
                const behaviorData = behaviorScores[key] || { score: 100, history: [], disciplinaryCount: 0 };

                html += `<div class="p-3 border rounded-lg">`;
                html += `<div class="flex items-center justify-between mb-2">`;
                html += `<span class="font-medium">${student.name}</span>`;
                html += `<span class="text-sm text-gray-600">‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô: ${behaviorData.disciplinaryCount}/3</span>`;
                html += `</div>`;
                
                if (behaviorData.disciplinaryCount < 3) {
                    html += `<div class="flex gap-2 items-center">`;
                    html += `<input type="text" id="disciplinary_reason_${student.studentId}" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô" class="flex-1 px-2 py-1 border rounded text-sm">`;
                    html += `<input type="file" id="disciplinary_file_${student.studentId}" accept=".pdf,.jpg,.jpeg,.png" class="text-sm">`;
                    html += `<button onclick="addDisciplinary('${student.studentId}')" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</button>`;
                    html += `</div>`;
                } else {
                    html += `<p class="text-red-600 text-sm">‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>`;
                }
                html += `</div>`;
            });

            html += '</div>';
            content.innerHTML = html;
        }

        function addScore(studentId) {
            const scoreInput = document.getElementById(`score_${studentId}`);
            const reasonInput = document.getElementById(`reason_${studentId}`);
            const score = parseInt(scoreInput.value);
            const reason = reasonInput.value;

            if (!score || !reason) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }

            const key = `${currentClassroom}_${studentId}`;
            if (!behaviorScores[key]) {
                behaviorScores[key] = { score: 100, history: [], disciplinaryCount: 0 };
            }

            behaviorScores[key].score += score;
            behaviorScores[key].history.push({
                date: new Date().toISOString(),
                action: '‡πÄ‡∏û‡∏¥‡πà‡∏°',
                score: score,
                reason: reason,
                newTotal: behaviorScores[key].score
            });

            scoreInput.value = '';
            reasonInput.value = '';
            saveAllData();
            loadBehaviorScores();
            showScoreManagement();
            alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function deductScore(studentId) {
            const scoreInput = document.getElementById(`score_${studentId}`);
            const reasonInput = document.getElementById(`reason_${studentId}`);
            const score = parseInt(scoreInput.value);
            const reason = reasonInput.value;

            if (!score || !reason) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }

            const key = `${currentClassroom}_${studentId}`;
            if (!behaviorScores[key]) {
                behaviorScores[key] = { score: 100, history: [], disciplinaryCount: 0 };
            }

            behaviorScores[key].score -= score;
            behaviorScores[key].history.push({
                date: new Date().toISOString(),
                action: '‡∏´‡∏±‡∏Å',
                score: score,
                reason: reason,
                newTotal: behaviorScores[key].score
            });

            scoreInput.value = '';
            reasonInput.value = '';
            saveAllData();
            loadBehaviorScores();
            showScoreManagement();
            alert('‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function addDisciplinary(studentId) {
            const reasonInput = document.getElementById(`disciplinary_reason_${studentId}`);
            const fileInput = document.getElementById(`disciplinary_file_${studentId}`);
            const reason = reasonInput.value;

            if (!reason) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }

            const key = `${currentClassroom}_${studentId}`;
            if (!behaviorScores[key]) {
                behaviorScores[key] = { score: 100, history: [], disciplinaryCount: 0 };
            }

            if (!disciplinaryRecords[key]) {
                disciplinaryRecords[key] = [];
            }

            behaviorScores[key].disciplinaryCount++;

            const record = {
                date: new Date().toISOString(),
                count: behaviorScores[key].disciplinaryCount,
                reason: reason,
                fileName: fileInput.files[0] ? fileInput.files[0].name : null
            };

            // Handle file upload (in real implementation, this would upload to server)
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    record.fileData = e.target.result;
                    disciplinaryRecords[key].push(record);
                    saveAllData();
                    loadBehaviorScores();
                    showDisciplinaryManagement();
                    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                disciplinaryRecords[key].push(record);
                saveAllData();
                loadBehaviorScores();
                showDisciplinaryManagement();
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }

            reasonInput.value = '';
            fileInput.value = '';
        }

        let deleteHistoryData = {};

        function showStudentHistory(studentId, type) {
            if (!type) return;

            const key = `${currentClassroom}_${studentId}`;
            const student = classroomData[currentClassroom].students.find(s => s.studentId === studentId);
            
            let content = `<h3 class="text-lg font-semibold mb-4">${student.name}</h3>`;

            if (type === 'history') {
                const behaviorData = behaviorScores[key] || { score: 100, history: [] };
                content += '<h4 class="font-medium mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>';
                
                if (behaviorData.history.length === 0) {
                    content += '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>';
                } else {
                    content += '<div class="space-y-2">';
                    behaviorData.history.forEach((record, index) => {
                        const date = new Date(record.date).toLocaleString('th-TH');
                        const actionClass = record.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°' ? 'text-green-600' : 'text-red-600';
                        content += `
                            <div class="p-3 border rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <span class="${actionClass} font-medium">${record.action} ${record.score} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                                        <p class="text-sm text-gray-600 mt-1">${record.reason}</p>
                                    </div>
                                    <div class="text-right text-sm text-gray-500">
                                        <div>${date}</div>
                                        <div>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: ${record.newTotal}</div>
                                        <button onclick="requestDeleteHistory('${studentId}', ${index})" class="text-red-600 hover:underline mt-1 text-xs">‡∏•‡∏ö</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    content += '</div>';
                }
            } else if (type === 'disciplinary') {
                const records = disciplinaryRecords[key] || [];
                content += '<h4 class="font-medium mb-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</h4>';
                
                if (records.length === 0) {
                    content += '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô</p>';
                } else {
                    content += '<div class="space-y-2">';
                    records.forEach(record => {
                        const date = new Date(record.date).toLocaleString('th-TH');
                        content += `
                            <div class="p-3 border rounded-lg">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="font-medium text-orange-600">‡∏ó‡∏±‡∏ì‡∏ë‡πå‡∏ö‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${record.count}</span>
                                        <p class="text-sm text-gray-600 mt-1">${record.reason}</p>
                                        ${record.fileName ? `<p class="text-sm text-blue-600 mt-1">üìé ${record.fileName}</p>` : ''}
                                    </div>
                                    <div class="text-right text-sm text-gray-500">
                                        <div>${date}</div>
                                        ${record.fileData ? `<button onclick="viewFile('${record.fileData}', '${record.fileName}')" class="text-blue-600 hover:underline mt-1">‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå</button>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    content += '</div>';
                }
            }

            content += '<div class="mt-4"><button onclick="closeModal(\'historyModal\')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button></div>';

            // Create and show history modal
            const modal = document.createElement('div');
            modal.id = 'historyModal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `<div class="modal-content">${content}</div>`;
            document.body.appendChild(modal);

            // Reset select
            event.target.value = '';
        }

        function requestDeleteHistory(studentId, historyIndex) {
            deleteHistoryData = { studentId, historyIndex };
            passwordAction = 'deleteHistory';
            closeModal('historyModal');
            document.getElementById('passwordModal').style.display = 'block';
        }

        function executeDeleteHistory() {
            const { studentId, historyIndex } = deleteHistoryData;
            const key = `${currentClassroom}_${studentId}`;
            const behaviorData = behaviorScores[key];
            
            if (behaviorData && behaviorData.history[historyIndex]) {
                const deletedRecord = behaviorData.history[historyIndex];
                
                // Recalculate score by removing this record's effect
                if (deletedRecord.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°') {
                    behaviorData.score -= deletedRecord.score;
                } else {
                    behaviorData.score += deletedRecord.score;
                }
                
                // Remove the record
                behaviorData.history.splice(historyIndex, 1);
                
                // Recalculate all subsequent records
                let runningScore = 100;
                behaviorData.history.forEach(record => {
                    if (record.action === '‡πÄ‡∏û‡∏¥‡πà‡∏°') {
                        runningScore += record.score;
                    } else {
                        runningScore -= record.score;
                    }
                    record.newTotal = runningScore;
                });
                
                behaviorData.score = runningScore;
                
                saveAllData();
                loadBehaviorScores();
                alert('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        function viewFile(fileData, fileName) {
            const newWindow = window.open();
            if (fileName.toLowerCase().includes('.pdf')) {
                newWindow.document.write(`<iframe src="${fileData}" width="100%" height="100%"></iframe>`);
            } else {
                newWindow.document.write(`<img src="${fileData}" style="max-width: 100%; height: auto;">`);
            }
        }

        function addNewClassroom() {
            const level = document.getElementById('newClassLevel').value;
            const teacher = document.getElementById('newTeacherName').value;
            const studentListText = document.getElementById('newStudentList').value;

            if (!level || !teacher || !studentListText) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const students = [];
            const lines = studentListText.split('\n');
            
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const student = {
                        id: parseInt(parts[0].trim()),
                        studentId: parts[1].trim(),
                        name: parts[2].trim(),
                        image: ''
                    };
                    students.push(student);

                    // Initialize behavior score
                    const key = `${level}_${student.studentId}`;
                    behaviorScores[key] = {
                        score: 100,
                        history: [],
                        disciplinaryCount: 0
                    };
                }
            });

            classroomData[level] = {
                level: level,
                teacher: teacher,
                students: students
            };

            saveAllData();
            loadClassrooms();
            closeModal('addClassroomModal');
            
            // Clear form
            document.getElementById('newClassLevel').value = '';
            document.getElementById('newTeacherName').value = '';
            document.getElementById('newStudentList').value = '';
            
            alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function editStudent(studentId) {
            const classroom = classroomData[currentClassroom];
            const student = classroom.students.find(s => s.studentId === studentId);

            const content = `
                <div class="space-y-4">
                    <div>
                        <label class="block font-medium mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label>
                        <input type="number" id="editStudentId" value="${student.id}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</label>
                        <input type="text" id="editStudentCode" value="${student.studentId}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</label>
                        <input type="text" id="editStudentName" value="${student.name}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
                        <input type="file" id="editStudentImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        ${student.image ? `<img src="${student.image}" alt="Current" class="mt-2 w-20 h-20 rounded-full object-cover">` : ''}
                    </div>
                    <div class="flex gap-4">
                        <button onclick="saveStudentEdit('${studentId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex-1">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button onclick="closeModal('editStudentModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            `;

            document.getElementById('editStudentContent').innerHTML = content;
            document.getElementById('editStudentModal').style.display = 'block';
        }

        function saveStudentEdit(oldStudentId) {
            const newId = parseInt(document.getElementById('editStudentId').value);
            const newCode = document.getElementById('editStudentCode').value;
            const newName = document.getElementById('editStudentName').value;
            const imageFile = document.getElementById('editStudentImage').files[0];

            if (!newId || !newCode || !newName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const classroom = classroomData[currentClassroom];
            const studentIndex = classroom.students.findIndex(s => s.studentId === oldStudentId);
            
            if (studentIndex !== -1) {
                classroom.students[studentIndex].id = newId;
                classroom.students[studentIndex].studentId = newCode;
                classroom.students[studentIndex].name = newName;

                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        classroom.students[studentIndex].image = e.target.result;
                        saveAllData();
                        loadManageStudents();
                        loadStudentList();
                        closeModal('editStudentModal');
                        alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    saveAllData();
                    loadManageStudents();
                    loadStudentList();
                    closeModal('editStudentModal');
                    alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                }
            }
        }

        function deleteStudent(studentId) {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                const classroom = classroomData[currentClassroom];
                classroom.students = classroom.students.filter(s => s.studentId !== studentId);
                
                // Remove related data
                const key = `${currentClassroom}_${studentId}`;
                delete behaviorScores[key];
                delete disciplinaryRecords[key];
                
                // Remove attendance data
                Object.keys(attendanceData).forEach(attendanceKey => {
                    if (attendanceKey.includes(`_${studentId}`)) {
                        delete attendanceData[attendanceKey];
                    }
                });

                saveAllData();
                loadManageStudents();
                loadStudentList();
                alert('‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        function addStudent() {
            const content = `
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                    <div>
                        <label class="block font-medium mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label>
                        <input type="number" id="newStudentId" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</label>
                        <input type="text" id="newStudentCode" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</label>
                        <input type="text" id="newStudentName" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block font-medium mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
                        <input type="file" id="newStudentImage" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="saveNewStudent()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex-1">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                        <button onclick="closeModal('editStudentModal')" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg flex-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            `;

            document.getElementById('editStudentContent').innerHTML = content;
            document.getElementById('editStudentModal').style.display = 'block';
        }

        function saveNewStudent() {
            const id = parseInt(document.getElementById('newStudentId').value);
            const code = document.getElementById('newStudentCode').value;
            const name = document.getElementById('newStudentName').value;
            const imageFile = document.getElementById('newStudentImage').files[0];

            if (!id || !code || !name) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            const classroom = classroomData[currentClassroom];
            
            // Check if student ID already exists
            if (classroom.students.some(s => s.studentId === code)) {
                alert('‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            const newStudent = {
                id: id,
                studentId: code,
                name: name,
                image: ''
            };

            // Initialize behavior score
            const key = `${currentClassroom}_${code}`;
            behaviorScores[key] = {
                score: 100,
                history: [],
                disciplinaryCount: 0
            };

            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    newStudent.image = e.target.result;
                    classroom.students.push(newStudent);
                    saveAllData();
                    loadManageStudents();
                    loadStudentList();
                    closeModal('editStudentModal');
                    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
                };
                reader.readAsDataURL(imageFile);
            } else {
                classroom.students.push(newStudent);
                saveAllData();
                loadManageStudents();
                loadStudentList();
                closeModal('editStudentModal');
                alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            
            // Remove dynamically created modals
            if (modalId === 'historyModal') {
                const modal = document.getElementById('historyModal');
                if (modal) modal.remove();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        function loadSelectedClassroomData() {
            const selectedClass = document.getElementById('manageClassroomSelect').value;
            const dataDiv = document.getElementById('selectedClassroomData');
            
            if (!selectedClass) {
                dataDiv.innerHTML = '';
                return;
            }
            
            const classroom = classroomData[selectedClass];
            
            let html = `
                <div class="bg-blue-50 rounded-lg p-6 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-blue-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${selectedClass}</h4>
                        <div class="flex gap-2">
                            <button onclick="editSelectedClassroom('${selectedClass}')" class="primary-blue text-white px-4 py-2 rounded-lg text-sm primary-blue-hover">
                                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button onclick="deleteClassroom('${selectedClass}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <span class="font-medium text-gray-700">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤:</span>
                            <span class="ml-2">${classroom.teacher}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                            <span class="ml-2">${classroom.students.length} ‡∏Ñ‡∏ô</span>
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</h5>
                        <div class="bg-white rounded border p-4 max-h-60 overflow-y-auto">
                            <div class="text-sm font-mono">
                                ${classroom.students.map(student => 
                                    `${student.id},${student.studentId},${student.name}`
                                ).join('<br>')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-sm text-gray-600">
                        <p>üí° ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏±‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</p>
                    </div>
                </div>
            `;
            
            dataDiv.innerHTML = html;
        }

        function showAddNewClassroom() {
            // Clear the form for new classroom
            document.getElementById('newClassLevel').value = '';
            document.getElementById('newTeacherName').value = '';
            document.getElementById('newStudentList').value = '';
            
            // Change modal title and button
            document.querySelector('#addClassroomModal h3').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà';
            document.querySelector('#addClassroomModal button[onclick="addNewClassroom()"]').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            document.querySelector('#addClassroomModal button[onclick="addNewClassroom()"]').className = 'bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex-1';
            
            document.getElementById('addClassroomModal').style.display = 'block';
        }

        function editSelectedClassroom(classroomName) {
            const classroom = classroomData[classroomName];
            
            // Fill form with existing data
            document.getElementById('newClassLevel').value = classroom.level;
            document.getElementById('newTeacherName').value = classroom.teacher;
            
            // Format student list
            const studentListText = classroom.students.map(student => 
                `${student.id},${student.studentId},${student.name}`
            ).join('\n');
            document.getElementById('newStudentList').value = studentListText;
            
            // Change modal title and button for editing
            document.querySelector('#addClassroomModal h3').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            document.querySelector('#addClassroomModal button[onclick="addNewClassroom()"]').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
            document.querySelector('#addClassroomModal button[onclick="addNewClassroom()"]').className = 'primary-blue text-white px-6 py-2 rounded-lg flex-1 primary-blue-hover';
            
            // Store the original classroom name for editing
            document.getElementById('addClassroomModal').setAttribute('data-editing', classroomName);
            
            document.getElementById('addClassroomModal').style.display = 'block';
        }

        function deleteClassroom(classroomName) {
            if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${classroomName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ`)) {
                // Remove classroom data
                delete classroomData[classroomName];
                
                // Remove related attendance and behavior data
                Object.keys(attendanceData).forEach(key => {
                    if (key.startsWith(classroomName + '_')) {
                        delete attendanceData[key];
                    }
                });
                
                Object.keys(behaviorScores).forEach(key => {
                    if (key.startsWith(classroomName + '_')) {
                        delete behaviorScores[key];
                    }
                });
                
                Object.keys(disciplinaryRecords).forEach(key => {
                    if (key.startsWith(classroomName + '_')) {
                        delete disciplinaryRecords[key];
                    }
                });
                
                saveAllData();
                loadClassroomManagementSelect();
                loadClassrooms(); // Update main dropdown
                document.getElementById('selectedClassroomData').innerHTML = '';
                alert('‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        function addNewClassroom() {
            const level = document.getElementById('newClassLevel').value;
            const teacher = document.getElementById('newTeacherName').value;
            const studentListText = document.getElementById('newStudentList').value;
            const isEditing = document.getElementById('addClassroomModal').getAttribute('data-editing');

            if (!level || !teacher || !studentListText) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }

            // Check for duplicate classroom name (only when adding new, not editing)
            if (!isEditing && classroomData[level]) {
                alert('‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
                return;
            }

            const students = [];
            const lines = studentListText.split('\n');
            
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 3) {
                    const student = {
                        id: parseInt(parts[0].trim()),
                        studentId: parts[1].trim(),
                        name: parts[2].trim(),
                        image: ''
                    };
                    students.push(student);

                    // Initialize behavior score
                    const key = `${level}_${student.studentId}`;
                    if (!behaviorScores[key]) {
                        behaviorScores[key] = {
                            score: 100,
                            history: [],
                            disciplinaryCount: 0
                        };
                    }
                }
            });

            // If editing, remove old classroom data
            if (isEditing && isEditing !== level) {
                delete classroomData[isEditing];
            }

            classroomData[level] = {
                level: level,
                teacher: teacher,
                students: students
            };

            saveAllData();
            loadClassroomManagementSelect();
            loadClassrooms(); // Update main dropdown
            closeModal('addClassroomModal');
            
            // Clear form and reset modal
            document.getElementById('newClassLevel').value = '';
            document.getElementById('newTeacherName').value = '';
            document.getElementById('newStudentList').value = '';
            document.getElementById('addClassroomModal').removeAttribute('data-editing');
            
            // Select the classroom that was just added/edited
            document.getElementById('manageClassroomSelect').value = level;
            loadSelectedClassroomData();
            
            const action = isEditing ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡πÄ‡∏û‡∏¥‡πà‡∏°';
            alert(`${action}‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }

        // Update attendance list when date changes
        document.getElementById('attendanceDate').addEventListener('change', function() {
            if (currentClassroom) {
                loadStudentList();
            }
        });

        // Auto-reload student list when classroom changes
        document.getElementById('classroomSelect').addEventListener('change', function() {
            if (this.value) {
                loadStudentList();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96860112b2684f52',t:'MTc1NDA1ODMyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
